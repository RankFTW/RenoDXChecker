<?xml version="1.0" encoding="utf-8"?>
<Window
    x:Class="RenoDXChecker.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:vm="using:RenoDXChecker.ViewModels"
    Title="RenoDX Mod Manager">

    <Grid x:Name="RootGrid">
        <Grid.Background>
            <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                <GradientStop Color="#0A0A14" Offset="0"/>
                <GradientStop Color="#0F0F1F" Offset="1"/>
            </LinearGradientBrush>
        </Grid.Background>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- HEADER -->
        <Border Grid.Row="0" Padding="20,12" Background="#0D0D1C"
                BorderBrush="#1E1E3A" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="14" VerticalAlignment="Center">
                    <Border Width="36" Height="36" CornerRadius="9" Background="#FF6B35">
                        <TextBlock Text="R" FontSize="19" FontWeight="Bold" Foreground="White"
                                   HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <StackPanel VerticalAlignment="Center">
                        <TextBlock FontSize="17" FontWeight="Bold">
                            <Run Text="RenoDX" Foreground="#FF6B35"/>
                            <Run Text=" Mod Manager" Foreground="#E0E0F0"/>
                        </TextBlock>
                        <TextBlock Text="HDR mod detection &amp; management"
                                   FontSize="11" Foreground="#5A5A7A"/>
                    </StackPanel>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <Border Background="#1A2A1A" CornerRadius="20" Padding="12,4">
                        <TextBlock x:Name="InstalledCountText" Foreground="#A6E3A1"
                                   FontSize="12" Text="0 installed"/>
                    </Border>
                    <Button x:Name="RescanBtn" Click="RescanButton_Click"
                            CornerRadius="9" Padding="11,6"
                            Background="#1A1A2E" Foreground="#7A7A9A"
                            BorderBrush="#2A2A45" BorderThickness="1"
                            ToolTipService.ToolTip="Re-scan all game stores for new games">
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <TextBlock Text="âŸ³" FontSize="13"/>
                            <TextBlock Text="Rescan" FontSize="12"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="RefreshBtn" Click="RefreshButton_Click"
                            CornerRadius="9" Padding="11,6"
                            Background="#1E1E3A" Foreground="#CDD6F4"
                            BorderBrush="#2E2E4A" BorderThickness="1"
                            ToolTipService.ToolTip="Reload wiki mod list using saved game library">
                        <StackPanel Orientation="Horizontal" Spacing="5">
                            <TextBlock Text="â†»" FontSize="13"/>
                            <TextBlock Text="Refresh" FontSize="12"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="AboutBtn" Click="AboutButton_Click"
                            CornerRadius="9" Padding="11,6"
                            Background="#1A1A2E" Foreground="#89B4FA"
                            BorderBrush="#2A2A45" BorderThickness="1">
                        <TextBlock Text="â„¹  About" FontSize="12"/>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- FILTER BAR -->
        <Border Grid.Row="1" Padding="20,10" Background="#0B0B18"
                BorderBrush="#1A1A30" BorderThickness="0,0,0,1">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="6">
                    <Button x:Name="FilterDetected"
                            Content="ðŸŽ® Installed Games"
                            Click="Filter_Click" Tag="Detected"
                            CornerRadius="8" Padding="14,7" FontSize="13"
                            Background="#FF6B35" Foreground="White" BorderThickness="0"/>
                    <Button x:Name="FilterInstalled"
                            Content="âœ“ Installed Mods"
                            Click="Filter_Click" Tag="Installed"
                            CornerRadius="8" Padding="14,7" FontSize="13"
                            Background="#1E1E3A" Foreground="#BAC2DE" BorderThickness="0"/>
                </StackPanel>
                <TextBox Grid.Column="1" x:Name="SearchBox"
                         PlaceholderText="ðŸ”  Search games..."
                         TextChanged="SearchBox_TextChanged"
                         Width="240" CornerRadius="10"
                         Background="#151528" Foreground="#CDD6F4"
                         BorderBrush="#2A2A45"/>
            </Grid>
        </Border>

        <!-- CONTENT -->
        <Grid Grid.Row="2">

            <!-- Loading -->
            <StackPanel x:Name="LoadingPanel"
                        HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
                <ProgressRing x:Name="LoadingRing" IsActive="True"
                              Width="52" Height="52" Foreground="#FF6B35"/>
                <TextBlock x:Name="LoadingTitle" Text="Loading..."
                           FontSize="16" FontWeight="SemiBold" Foreground="#CDD6F4"
                           HorizontalAlignment="Center"/>
                <TextBlock x:Name="LoadingSubtitle" Text=""
                           FontSize="12" Foreground="#6C7086"
                           HorizontalAlignment="Center" MaxWidth="400"
                           TextWrapping="Wrap" TextAlignment="Center"/>
            </StackPanel>

            <!-- Cards â€” ItemsWrapGrid with ItemWidth so cards wrap responsively -->
            <ScrollViewer x:Name="CardsScroll" Visibility="Collapsed"
                          VerticalScrollBarVisibility="Auto" Padding="8,6">
                <ItemsControl x:Name="GameCardsList">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <!--
                                ItemWidth fixed so all cards are the same width.
                                No ItemHeight set â€” height is fixed via the card Border.
                                Cards wrap to fill the available window width automatically.
                            -->
                            <ItemsWrapGrid Orientation="Horizontal" ItemWidth="380"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate x:DataType="vm:GameCardViewModel">

                            <!-- Fixed-height card â€” every card is identical height so rows align -->
                            <Border Margin="6" CornerRadius="13"
                                    BorderThickness="1" BorderBrush="#252542"
                                    Height="230">
                                <Border.Background>
                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                        <GradientStop Color="#13132A" Offset="0"/>
                                        <GradientStop Color="#191932" Offset="1"/>
                                    </LinearGradientBrush>
                                </Border.Background>

                                <Grid Margin="14,12,14,12">
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="30"/>   <!-- 0: name + notes + status -->
                                        <RowDefinition Height="22"/>   <!-- 1: source/engine/generic badges -->
                                        <RowDefinition Height="Auto"/> <!-- 2: installed file badge (full width, collapses when empty) -->
                                        <RowDefinition Height="28"/>   <!-- 3: path row -->
                                        <RowDefinition Height="*"/>    <!-- 4: spacer -->
                                        <RowDefinition Height="36"/>   <!-- 5: action button -->
                                        <RowDefinition Height="Auto"/> <!-- 6: progress + message -->
                                    </Grid.RowDefinitions>

                                    <!-- Row 0: Game name | â„¹ btn | status badge -->
                                    <Grid Grid.Row="0" VerticalAlignment="Center">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBlock Grid.Column="0"
                                                   Text="{x:Bind GameName}"
                                                   FontSize="14" FontWeight="SemiBold"
                                                   Foreground="#E0E0F0"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxLines="1"
                                                   VerticalAlignment="Center"
                                                   ToolTipService.ToolTip="{x:Bind GameName}"/>

                                        <!-- Notes popup button â€” visible whenever HasNotes is true,
                                             which now includes ALL games with wiki tooltip notes
                                             AND all generic UE/Unity cards -->
                                        <Button Grid.Column="1"
                                                Visibility="{x:Bind NotesButtonVisibility}"
                                                Click="NotesButton_Click" Tag="{x:Bind}"
                                                Background="Transparent" BorderThickness="0"
                                                Padding="5,0" Margin="3,0,0,0"
                                                VerticalAlignment="Center"
                                                ToolTipService.ToolTip="View setup notes">
                                            <TextBlock Text="â„¹" FontSize="12" Foreground="#89B4FA"/>
                                        </Button>

                                        <Border Grid.Column="2"
                                                CornerRadius="20" Padding="7,2"
                                                Margin="3,0,0,0"
                                                BorderThickness="1" BorderBrush="#333355"
                                                VerticalAlignment="Center">
                                            <TextBlock Text="{x:Bind WikiStatusLabel}"
                                                       FontSize="10" Foreground="#808098"/>
                                        </Border>
                                    </Grid>

                                    <!-- Row 1: Badges â€” clipped container prevents any overflow -->
                                    <Grid Grid.Row="1" VerticalAlignment="Center"
                                          HorizontalAlignment="Stretch">
                                        <!-- Clip content to the cell bounds -->
                                        <Grid.Clip>
                                            <RectangleGeometry Rect="0,0,2000,24"/>
                                        </Grid.Clip>
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <Border Background="#1C1C3A" CornerRadius="5"
                                                    Padding="6,2"
                                                    Visibility="{x:Bind SourceBadgeVisibility}">
                                                <TextBlock FontSize="10" Foreground="#666688"
                                                           MaxLines="1" TextTrimming="CharacterEllipsis">
                                                    <Run Text="{x:Bind SourceIcon}"/>
                                                    <Run Text=" "/>
                                                    <Run Text="{x:Bind Source}"/>
                                                </TextBlock>
                                            </Border>
                                            <Border Background="#18183A" CornerRadius="5"
                                                    Padding="6,2"
                                                    BorderBrush="#404088" BorderThickness="1"
                                                    Visibility="{x:Bind EngineBadgeVisibility}">
                                                <TextBlock Text="{x:Bind EngineHint}"
                                                           FontSize="10" Foreground="#CBA6F7"
                                                           MaxLines="1" TextTrimming="CharacterEllipsis"
                                                           MaxWidth="110"/>
                                            </Border>
                                            <Border Background="#281800" CornerRadius="5"
                                                    Padding="6,2"
                                                    BorderBrush="#FAB387" BorderThickness="1"
                                                    Visibility="{x:Bind GenericBadgeVisibility}">
                                                <TextBlock Text="{x:Bind GenericModLabel}"
                                                           FontSize="10" Foreground="#FAB387"
                                                           MaxLines="1" TextTrimming="CharacterEllipsis"
                                                           MaxWidth="90"/>
                                            </Border>

                                        </StackPanel>
                                    </Grid>

                                    <!-- Row 2: Installed file badge â€” full width, never truncated -->
                                    <Border Grid.Row="2" VerticalAlignment="Center"
                                            Background="#0A1C0A" CornerRadius="5"
                                            Padding="7,2" BorderBrush="#2A4A2A" BorderThickness="1"
                                            Visibility="{x:Bind InstalledFileLabelVisible, Mode=OneWay}">
                                        <TextBlock Text="{x:Bind InstalledFileLabel, Mode=OneWay}"
                                                   FontSize="10" Foreground="#6AAA6A"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxLines="1"/>
                                    </Border>

                                    <!-- Row 3: Path row (detected) â€” single folder button opens flyout -->
                                    <Border Grid.Row="3" Background="#0C0C20" CornerRadius="7"
                                            Padding="10,0" VerticalAlignment="Stretch"
                                            Visibility="{x:Bind DetectedVisibility, Mode=OneWay}">
                                        <Grid VerticalAlignment="Center">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Grid.Column="0"
                                                       Text="{x:Bind InstallPathDisplay, Mode=OneWay}"
                                                       FontSize="10" Foreground="#3E3E60"
                                                       FontFamily="Consolas"
                                                       TextTrimming="CharacterEllipsis"
                                                       VerticalAlignment="Center"
                                                       ToolTipService.ToolTip="{x:Bind InstallPath, Mode=OneWay}"/>
                                            <!-- Single folder button with flyout menu -->
                                            <Button Grid.Column="1"
                                                    Background="Transparent" BorderThickness="0"
                                                    Padding="6,0" VerticalAlignment="Center"
                                                    ToolTipService.ToolTip="Folder options">
                                                <Button.Flyout>
                                                    <MenuFlyout>
                                                        <MenuFlyoutItem Text="ðŸ“‚  Open in Explorer"
                                                                        Click="OpenFolder_Click"
                                                                        Tag="{x:Bind}"/>
                                                        <MenuFlyoutItem Text="ðŸ“  Change install folder"
                                                                        Click="BrowseFolder_Click"
                                                                        Tag="{x:Bind}"/>
                                                    </MenuFlyout>
                                                </Button.Flyout>
                                                <TextBlock Text="ðŸ“" FontSize="12" Foreground="#4A4A6A"/>
                                            </Button>
                                        </Grid>
                                    </Border>

                                    <!-- Row 2: Not detected -->
                                    <Border Grid.Row="3" Background="#0C0C20" CornerRadius="7"
                                            Padding="10,0" VerticalAlignment="Stretch"
                                            Visibility="{x:Bind NotDetectedVisibility, Mode=OneWay}">
                                        <StackPanel Orientation="Horizontal" Spacing="8"
                                                    VerticalAlignment="Center">
                                            <TextBlock Text="Game folder not detected"
                                                       FontSize="10" Foreground="#2E2E50"
                                                       VerticalAlignment="Center"/>
                                            <Button Content="ðŸ“ Set folder" FontSize="10"
                                                    Background="#1C1C3A" Foreground="#505070"
                                                    CornerRadius="5" Padding="7,3" BorderThickness="0"
                                                    Click="SetFolder_Click" Tag="{x:Bind}"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Row 3: spacer -->
                                    <Grid Grid.Row="4"/>

                                    <!-- Row 4: Install / Reinstall+Delete buttons -->
                                    <!-- Plain install (not yet installed) -->
                                    <Button Grid.Row="5"
                                            Visibility="{x:Bind InstallOnlyBtnVisibility, Mode=OneWay}"
                                            IsEnabled="{x:Bind CanInstall, Mode=OneWay}"
                                            Click="InstallButton_Click" Tag="{x:Bind}"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            CornerRadius="10"
                                            FontSize="13" FontWeight="SemiBold" Foreground="White">
                                        <Button.Background>
                                            <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                <GradientStop Color="#FF6B35" Offset="0"/>
                                                <GradientStop Color="#E04000" Offset="1"/>
                                            </LinearGradientBrush>
                                        </Button.Background>
                                        <TextBlock Text="â¬‡  Install" FontSize="13"/>
                                    </Button>

                                    <!-- Unity generic: dual 32/64 install buttons -->
                                    <Grid Grid.Row="5"
                                          Visibility="{x:Bind DualBitInstallVisibility, Mode=OneWay}"
                                          VerticalAlignment="Stretch">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="8"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Button Grid.Column="0"
                                                Click="Install64Button_Click" Tag="{x:Bind}"
                                                HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                                                CornerRadius="10" FontSize="12" FontWeight="SemiBold"
                                                Foreground="White">
                                            <Button.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                    <GradientStop Color="#FF6B35" Offset="0"/>
                                                    <GradientStop Color="#E04000" Offset="1"/>
                                                </LinearGradientBrush>
                                            </Button.Background>
                                            <TextBlock Text="â¬‡  Install 64-bit" FontSize="12"/>
                                        </Button>
                                        <Button Grid.Column="2"
                                                Click="Install32Button_Click" Tag="{x:Bind}"
                                                HorizontalAlignment="Stretch" VerticalAlignment="Stretch"
                                                CornerRadius="10" FontSize="12" FontWeight="SemiBold"
                                                Background="#1C2A3A" Foreground="#89B4FA"
                                                BorderBrush="#2A3A4A" BorderThickness="1">
                                            <TextBlock Text="â¬‡  Install 32-bit" FontSize="12"/>
                                        </Button>
                                    </Grid>

                                    <!-- Reinstall + Delete (when already installed) -->
                                    <Grid Grid.Row="5"
                                          Visibility="{x:Bind ReinstallRowVisibility, Mode=OneWay}"
                                          VerticalAlignment="Stretch">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="44"/>
                                        </Grid.ColumnDefinitions>
                                        <Button Grid.Column="0"
                                                IsEnabled="{x:Bind CanInstall, Mode=OneWay}"
                                                Click="InstallButton_Click" Tag="{x:Bind}"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                CornerRadius="10,0,0,10"
                                                FontSize="13" FontWeight="SemiBold" Foreground="White"
                                                Margin="0,0,1,0">
                                            <Button.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                    <GradientStop Color="#FF6B35" Offset="0"/>
                                                    <GradientStop Color="#E04000" Offset="1"/>
                                                </LinearGradientBrush>
                                            </Button.Background>
                                            <TextBlock Text="â†º  Reinstall" FontSize="13"/>
                                        </Button>
                                        <Button Grid.Column="1"
                                                Click="UninstallButton_Click" Tag="{x:Bind}"
                                                HorizontalAlignment="Stretch"
                                                VerticalAlignment="Stretch"
                                                CornerRadius="0,10,10,0"
                                                Background="#2A0A0A"
                                                BorderBrush="#4A1A1A" BorderThickness="1"
                                                ToolTipService.ToolTip="Remove mod"
                                                Foreground="#F38BA8" FontSize="14">
                                            <TextBlock Text="ðŸ—‘" FontSize="14"/>
                                        </Button>
                                    </Grid>

                                    <Button Grid.Row="5"
                                            Visibility="{x:Bind ExternalBtnVisibility}"
                                            HorizontalAlignment="Stretch"
                                            VerticalAlignment="Stretch"
                                            CornerRadius="10"
                                            Background="#1C1C3A"
                                            BorderThickness="1" BorderBrush="#353555"
                                            Click="ExternalLink_Click" Tag="{x:Bind}">
                                        <StackPanel Orientation="Horizontal" Spacing="7"
                                                    HorizontalAlignment="Center">
                                            <TextBlock Text="ðŸŒ" FontSize="13"/>
                                            <TextBlock Text="{x:Bind ExternalLabel}"
                                                       FontSize="12" Foreground="#89B4FA"/>
                                        </StackPanel>
                                    </Button>

                                    <!-- Row 5: Progress bar + status message -->
                                    <StackPanel Grid.Row="6" Spacing="3" Margin="0,5,0,0">
                                        <ProgressBar
                                            Visibility="{x:Bind ProgressVisibility, Mode=OneWay}"
                                            Value="{x:Bind InstallProgress, Mode=OneWay}"
                                            Maximum="100" Height="3" CornerRadius="2"
                                            Foreground="#FF6B35" Background="#1E1E3A"/>
                                        <TextBlock
                                            Visibility="{x:Bind MessageVisibility, Mode=OneWay}"
                                            Text="{x:Bind ActionMessage, Mode=OneWay}"
                                            FontSize="10" Foreground="#55557A"
                                            TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Grid>
                            </Border>

                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>
        </Grid>

        <!-- STATUS BAR -->
        <Border Grid.Row="3" Padding="20,7" Background="#0A0A14"
                BorderBrush="#181828" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <Ellipse x:Name="StatusDot" Grid.Column="0"
                         Width="7" Height="7" Margin="0,0,8,0"
                         VerticalAlignment="Center" Fill="#FAB387"/>
                <TextBlock x:Name="StatusBarText" Grid.Column="1"
                           Text="Starting..." FontSize="11"
                           Foreground="#404055" VerticalAlignment="Center"/>
                <TextBlock x:Name="GameCountText" Grid.Column="2"
                           Text="" FontSize="11"
                           Foreground="#303045" VerticalAlignment="Center"/>
            </Grid>
        </Border>

    </Grid>
</Window>
